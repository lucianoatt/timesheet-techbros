<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Timesheet TechBros</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: calc(100vh - 40px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .server-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            color: #155724;
            font-size: 14px;
            margin-top: 10px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .admin-dashboard {
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn {
            padding: 15px 30px;
            margin: 10px 5px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-full {
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2a5298, #1e3c72);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .menu-card:hover {
            transform: translateY(-5px);
        }

        .status-message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .section-title {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .data-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .data-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .back-btn {
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2a5298;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }

        .online {
            background: #28a745;
        }

        .offline {
            background: #dc3545;
        }

        .api-status {
            background: #17a2b8;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="connection-status" class="connection-status online">üü¢ Conectado</div>
    
    <div class="container">
        <div class="header">
            <h1>Panel de Administraci√≥n TechBros</h1>
            <p>Sistema de gesti√≥n centralizado para Timesheet App</p>
            <div class="server-info">
                üåê Servidor: timesheet-techbros.netlify.app
            </div>
        </div>

        <div class="api-status" id="api-status">
            üîÑ Verificando conexi√≥n con el servidor...
        </div>

        <div id="status-message" class="status-message"></div>
        
        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando datos del servidor...</p>
        </div>

        <!-- Login Form -->
        <div id="login-form" class="login-form">
            <div class="form-group">
                <label for="admin-username">Usuario Administrador</label>
                <input type="text" id="admin-username" value="Admin" required>
            </div>
            <div class="form-group">
                <label for="admin-password">Contrase√±a</label>
                <input type="password" id="admin-password" required>
            </div>
            <button class="btn btn-primary btn-full" onclick="adminLogin()">Iniciar Sesi√≥n</button>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="admin-dashboard">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">Usuarios Registrados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-records">0</div>
                    <div class="stat-label">Registros de Tiempo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-expenses">0</div>
                    <div class="stat-label">Gastos Registrados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-gpx">0</div>
                    <div class="stat-label">Puntos GPS</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-card">
                    <h3>Gesti√≥n de Usuarios</h3>
                    <p>Agregar, modificar o eliminar cuentas de usuario</p>
                    <button class="btn btn-primary" onclick="showUserManagement()">Administrar Usuarios</button>
                </div>
                
                <div class="menu-card">
                    <h3>Reportes de Tiempo</h3>
                    <p>Generar y descargar reportes de timesheet</p>
                    <button class="btn btn-success" onclick="showTimesheetReports()">Generar Timesheet</button>
                </div>
                
                <div class="menu-card">
                    <h3>Archivos GPX</h3>
                    <p>Descargar archivos de seguimiento GPS</p>
                    <button class="btn btn-info" onclick="showGPXReports()">Generar Archivo GPX</button>
                </div>
                
                <div class="menu-card">
                    <h3>Reportes de Gastos</h3>
                    <p>Generar y descargar reportes de gastos</p>
                    <button class="btn btn-warning" onclick="showExpenseReports()">Generar Gastos</button>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="adminLogout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- User Management Section -->
        <div id="user-management" class="hidden">
            <h2 class="section-title">Gesti√≥n de Usuarios</h2>
            
            <div class="form-group">
                <button class="btn btn-success" onclick="showAddUserForm()">Agregar Nuevo Usuario</button>
                <button class="btn btn-warning" onclick="showUserList()">Ver Usuarios</button>
                <button class="btn btn-info" onclick="testServerConnection()">Probar Conexi√≥n</button>
            </div>

            <!-- Add User Form -->
            <div id="add-user-form" class="hidden">
                <h3>Agregar Nuevo Usuario</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-username">Nombre de Usuario</label>
                        <input type="text" id="new-username" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">Contrase√±a</label>
                        <input type="password" id="new-password" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-complete-name">Nombre Completo</label>
                        <input type="text" id="new-complete-name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-position">Posici√≥n</label>
                        <select id="new-position" required>
                            <option value="">Seleccionar Posici√≥n</option>
                            <option value="Driver">Conductor</option>
                            <option value="Engineer">Ingeniero</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="new-phone">N√∫mero de Tel√©fono</label>
                    <input type="tel" id="new-phone" required>
                </div>
                <button class="btn btn-success" onclick="addUser()">Agregar Usuario</button>
            </div>

            <!-- User List -->
            <div id="user-list" class="hidden">
                <h3>Lista de Usuarios</h3>
                <div id="users-display" class="data-display"></div>
                <button class="btn btn-danger" onclick="deleteSelectedUser()">Eliminar Usuario Seleccionado</button>
            </div>
            
            <button class="btn btn-secondary back-btn" onclick="backToMainMenu()">Volver al Men√∫ Principal</button>
        </div>

        <!-- Timesheet Reports -->
        <div id="timesheet-reports" class="hidden">
            <h2 class="section-title">Generar Reporte de Timesheet</h2>
            
            <div class="form-group">
                <label for="timesheet-user-select">Seleccionar Usuario</label>
                <select id="timesheet-user-select"></select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="timesheet-month">Mes</label>
                    <select id="timesheet-month">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timesheet-year">A√±o</label>
                    <select id="timesheet-year"></select>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="generateTimesheetReport()">Generar y Descargar</button>
            
            <div id="timesheet-data" class="data-display hidden"></div>
            
            <button class="btn btn-secondary back-btn" onclick="backToMainMenu()">Volver al Men√∫ Principal</button>
        </div>

        <!-- GPX Reports -->
        <div id="gpx-reports" class="hidden">
            <h2 class="section-title">Generar Archivo GPX</h2>
            
            <div class="form-group">
                <label for="gpx-user-select">Seleccionar Usuario</label>
                <select id="gpx-user-select"></select>
            </div>
            
            <div class="form-group">
                <label for="gpx-date">Seleccionar Fecha</label>
                <input type="date" id="gpx-date">
            </div>
            
            <button class="btn btn-info" onclick="generateGPXFile()">Generar y Descargar</button>
            
            <div id="gpx-data" class="data-display hidden"></div>
            
            <button class="btn btn-secondary back-btn" onclick="backToMainMenu()">Volver al Men√∫ Principal</button>
        </div>

        <!-- Expense Reports -->
        <div id="expense-reports" class="hidden">
            <h2 class="section-title">Generar Reporte de Gastos</h2>
            
            <div class="form-group">
                <label for="expense-user-select">Seleccionar Usuario</label>
                <select id="expense-user-select"></select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="expense-month">Mes</label>
                    <select id="expense-month">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expense-year">A√±o</label>
                    <select id="expense-year"></select>
                </div>
            </div>
            
            <button class="btn btn-warning" onclick="generateExpenseReport()">Generar y Descargar</button>
            
            <div id="expense-data" class="data-display hidden"></div>
            
            <button class="btn btn-secondary back-btn" onclick="backToMainMenu()">Volver al Men√∫ Principal</button>
        </div>
    </div>

    <script>
        // ‚úÖ CONFIGURACI√ìN DEL SERVIDOR - TU URL ESPEC√çFICA
        const API_BASE_URL = 'https://timesheet-techbros.netlify.app/.netlify/functions';
        
        // Variables globales
        let users = [];
        let allTimesheetData = [];
        let allGpxData = [];
        let allExpenseData = [];
        let adminToken = null;
        let serverOnline = false;

        // Monitoreo de conexi√≥n
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (navigator.onLine && serverOnline) {
                statusElement.textContent = 'üü¢ Conectado';
                statusElement.className = 'connection-status online';
            } else {
                statusElement.textContent = 'üî¥ Sin conexi√≥n';
                statusElement.className = 'connection-status offline';
            }
        }

        async function testServerConnection() {
            const apiStatus = document.getElementById('api-status');
            apiStatus.textContent = 'üîÑ Probando conexi√≥n con el servidor...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth-verify`);
                if (response.ok || response.status === 401) { // 401 es OK, significa que el endpoint existe
                    serverOnline = true;
                    apiStatus.textContent = '‚úÖ Servidor en l√≠nea y funcionando correctamente';
                    apiStatus.style.background = '#28a745';
                    showStatus('Conexi√≥n al servidor exitosa', 'success');
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                serverOnline = false;
                apiStatus.textContent = '‚ùå Error: No se puede conectar al servidor';
                apiStatus.style.background = '#dc3545';
                showStatus('Error de conexi√≥n al servidor', 'error');
            }
            updateConnectionStatus();
        }

        window.addEventListener('online', () => {
            updateConnectionStatus();
            testServerConnection();
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus();
        });

        // Funciones de API
        async function apiRequest(endpoint, method = 'GET', data = null) {
            showLoading(true);
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (adminToken) {
                    options.headers['Authorization'] = `Bearer ${adminToken}`;
                }

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                serverOnline = true;
                updateConnectionStatus();
                return await response.json();
            } catch (error) {
                console.error('API Request failed:', error);
                serverOnline = false;
                updateConnectionStatus();
                // Fallback a datos locales en caso de error
                return null;
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function init() {
            populateYearSelectors();
            updateConnectionStatus();
            testServerConnection();
            loadUsersFromLocalStorage();
            loadDashboardStats();
        }

        function populateYearSelectors() {
            const currentYear = new Date().getFullYear();
            const yearSelectors = ['timesheet-year', 'expense-year'];
            
            yearSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                selector.innerHTML = '';
                for (let year = currentYear - 5; year <= currentYear + 2; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    selector.appendChild(option);
                }
            });
        }

        function adminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            if (username === 'Admin' && password === 'Faa@61997') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                showStatus('¬°Bienvenido Administrador!', 'success');
                loadDashboardStats();
                loadDataFromAPI();
            } else {
                showStatus('Credenciales inv√°lidas. Int√©ntalo de nuevo.', 'error');
            }
        }

        function adminLogout() {
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            hideAllSections();
            adminToken = null;
            showStatus('Sesi√≥n cerrada exitosamente.', 'success');
        }

        async function loadDataFromAPI() {
            try {
                // Intentar cargar datos del API
                showStatus('Cargando datos del servidor...', 'warning');
                
                const timesheetResponse = await apiRequest('/timesheet');
                if (timesheetResponse) {
                    allTimesheetData = timesheetResponse;
                }

                const gpxResponse = await apiRequest('/gpx');
                if (gpxResponse) {
                    allGpxData = gpxResponse;
                }

                const expenseResponse = await apiRequest('/expenses');
                if (expenseResponse) {
                    allExpenseData = expenseResponse;
                }

                if (timesheetResponse || gpxResponse || expenseResponse) {
                    showStatus('Datos cargados desde el servidor', 'success');
                } else {
                    showStatus('Sin datos en el servidor, usando datos locales', 'warning');
                    loadDataFromLocalStorage();
                }

                updateDashboardStats();
            } catch (error) {
                console.error('Error loading data from API:', error);
                showStatus('Error al conectar con el servidor, usando datos locales', 'error');
                loadDataFromLocalStorage();
            }
        }

        function loadDataFromLocalStorage() {
            // Fallback a localStorage
            allTimesheetData = JSON.parse(localStorage.getItem('allTimesheetData') || '[]');
            allGpxData = JSON.parse(localStorage.getItem('allGpxData') || '[]');
            allExpenseData = JSON.parse(localStorage.getItem('allExpenseData') || '[]');
            updateDashboardStats();
        }

        function loadUsersFromLocalStorage() {
            users = JSON.parse(localStorage.getItem('adminUsers') || '[]');
            
            if (users.length === 0) {
                users = [
                    {
                        id: 1,
                        username: 'juan_perez',
                        password: 'password123',
                        completeName: 'Juan P√©rez',
                        position: 'Driver',
                        phoneNumber: '+34123456789'
                    },
                    {
                        id: 2,
                        username: 'maria_garcia',
                        password: 'password456',
                        completeName: 'Mar√≠a Garc√≠a',
                        position: 'Engineer',
                        phoneNumber: '+34987654321'
                    },
                    {
                        id: 3,
                        username: 'admin_test',
                        password: 'test123',
                        completeName: 'Usuario de Prueba',
                        position: 'Engineer',
                        phoneNumber: '+34555123456'
                    }
                ];
                localStorage.setItem('adminUsers', JSON.stringify(users));
            }
        }

        function loadDashboardStats() {
            updateDashboardStats();
        }

        function updateDashboardStats() {
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('total-records').textContent = allTimesheetData.length;
            document.getElementById('total-expenses').textContent = allExpenseData.length;
            document.getElementById('total-gpx').textContent = allGpxData.length;
        }

        function hideAllSections() {
            const sections = ['user-management', 'timesheet-reports', 'gpx-reports', 'expense-reports'];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
        }

        function backToMainMenu() {
            hideAllSections();
            document.getElementById('admin-dashboard').style.display = 'block';
        }

        function showUserManagement() {
            hideAllSections();
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('user-management').classList.remove('hidden');
            populateUserSelectors();
        }

        function showTimesheetReports() {
            hideAllSections();
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('timesheet-reports').classList.remove('hidden');
            populateUserSelectors();
        }

        function showGPXReports() {
            hideAllSections();
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('gpx-reports').classList.remove('hidden');
            populateUserSelectors();
        }

        function showExpenseReports() {
            hideAllSections();
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('expense-reports').classList.remove('hidden');
            populateUserSelectors();
        }

        function populateUserSelectors() {
            const selectors = [
                'timesheet-user-select',
                'gpx-user-select', 
                'expense-user-select'
            ];

            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    selector.innerHTML = '<option value="">Seleccionar Usuario</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = `${user.completeName} (${user.username})`;
                        selector.appendChild(option);
                    });
                }
            });
        }

        function showAddUserForm() {
            document.getElementById('add-user-form').classList.remove('hidden');
            document.getElementById('user-list').classList.add('hidden');
        }

        function showUserList() {
            document.getElementById('add-user-form').classList.add('hidden');
            document.getElementById('user-list').classList.remove('hidden');
            displayUsers();
        }

        function displayUsers() {
            const usersDisplay = document.getElementById('users-display');
            usersDisplay.innerHTML = '';

            if (users.length === 0) {
                usersDisplay.innerHTML = '<p>No hay usuarios registrados.</p>';
                return;
            }

            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'data-item';
                userDiv.innerHTML = `
                    <input type="radio" name="selected-user" value="${user.username}" id="user-${user.id}">
                    <label for="user-${user.id}">
                        <strong>${user.completeName}</strong><br>
                        Usuario: ${user.username} | Posici√≥n: ${user.position} | Tel√©fono: ${user.phoneNumber}
                    </label>
                `;
                usersDisplay.appendChild(userDiv);
            });
        }

        function addUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const completeName = document.getElementById('new-complete-name').value;
            const position = document.getElementById('new-position').value;
            const phoneNumber = document.getElementById('new-phone').value;

            if (!username || !password || !completeName || !position || !phoneNumber) {
                showStatus('Por favor completa todos los campos.', 'error');
                return;
            }

            if (users.find(user => user.username === username)) {
                showStatus('El nombre de usuario ya existe. Elige otro diferente.', 'error');
                return;
            }

            const newUser = {
                id: Date.now(), // Usar timestamp como ID √∫nico
                username,
                password,
                completeName,
                position,
                phoneNumber
            };

            users.push(newUser);
            localStorage.setItem('adminUsers', JSON.stringify(users));
            
            // Clear form
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-complete-name').value = '';
            document.getElementById('new-position').value = '';
            document.getElementById('new-phone').value = '';

            showStatus('¬°Usuario agregado exitosamente!', 'success');
            populateUserSelectors();
            updateDashboardStats();
        }

        function deleteSelectedUser() {
            const selectedRadio = document.querySelector('input[name="selected-user"]:checked');
            
            if (!selectedRadio) {
                showStatus('Por favor selecciona un usuario para eliminar.', 'error');
                return;
            }

            const username = selectedRadio.value;
            users = users.filter(u => u.username !== username);
            localStorage.setItem('adminUsers', JSON.stringify(users));
            
            displayUsers();
            populateUserSelectors();
            updateDashboardStats();
            showStatus('Usuario eliminado exitosamente. Los datos en los registros se han preservado.', 'success');
        }

        async function generateTimesheetReport() {
            const selectedUser = document.getElementById('timesheet-user-select').value;
            const selectedMonth = document.getElementById('timesheet-month').value;
            const selectedYear = document.getElementById('timesheet-year').value;

            if (!selectedUser || !selectedMonth || !selectedYear) {
                showStatus('Por favor selecciona usuario, mes y a√±o.', 'error');
                return;
            }

            // Intentar obtener datos del API primero
            let timesheetData = allTimesheetData;
            
            try {
                const apiData = await apiRequest(`/timesheet?user=${selectedUser}&month=${selectedMonth}&year=${selectedYear}`);
                if (apiData && apiData.length > 0) {
                    timesheetData = apiData;
                    showStatus('Datos obtenidos del servidor', 'success');
                }
            } catch (error) {
                // Usar datos locales como fallback
                timesheetData = JSON.parse(localStorage.getItem('timesheetData') || '[]');
                showStatus('Usando datos locales (sin conexi√≥n al servidor)', 'warning');
            }

            const filteredData = timesheetData.filter(item => 
                item.user === selectedUser && 
                item.date.startsWith(`${selectedYear}-${selectedMonth.padStart(2, '0')}`)
            );

            if (filteredData.length === 0) {
                showStatus('No se encontraron datos para el per√≠odo seleccionado.', 'error');
                return;
            }

            displayTimesheetData(filteredData);
            downloadTimesheetCSV(filteredData, selectedUser, selectedYear, selectedMonth);
            showStatus(`¬°Reporte de timesheet generado para ${selectedUser}!`, 'success');
        }

        function displayTimesheetData(data) {
            const dataDisplay = document.getElementById('timesheet-data');
            dataDisplay.innerHTML = '<h4>Datos de Timesheet:</h4>';
            
            data.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'data-item';
                itemDiv.innerHTML = `
                    <strong>Fecha:</strong> ${item.date} <strong>Hora:</strong> ${item.time}<br>
                    <strong>Descripci√≥n:</strong> ${item.description}<br>
                    <strong>Ubicaci√≥n:</strong> ${item.latitude}, ${item.longitude}<br>
                    ${item.kilometers ? `<strong>Kil√≥metros:</strong> ${item.kilometers}` : ''}
                `;
                dataDisplay.appendChild(itemDiv);
            });

            dataDisplay.classList.remove('hidden');
        }

        async function generateGPXFile() {
            const selectedUser = document.getElementById('gpx-user-select').value;
            const selectedDate = document.getElementById('gpx-date').value;

            if (!selectedUser || !selectedDate) {
                showStatus('Por favor selecciona usuario y fecha.', 'error');
                return;
            }

            let gpxData = allGpxData;
            
            try {
                const apiData = await apiRequest(`/gpx?user=${selectedUser}&date=${selectedDate}`);
                if (apiData && apiData.length > 0) {
                    gpxData = apiData;
                    showStatus('Datos GPS obtenidos del servidor', 'success');
                }
            } catch (error) {
                gpxData = JSON.parse(localStorage.getItem('gpxData') || '[]');
                showStatus('Usando datos GPS locales', 'warning');
            }

            const filteredData = gpxData.filter(item => 
                item.user === selectedUser && 
                item.date === selectedDate
            );

            if (filteredData.length === 0) {
                showStatus('No se encontraron datos GPX para la fecha seleccionada.', 'error');
                return;
            }

            displayGPXData(filteredData);
            downloadGPXCSV(filteredData, selectedUser, selectedDate);
            showStatus(`¬°Archivo GPX generado para ${selectedUser}!`, 'success');
        }

        function displayGPXData(data) {
            const dataDisplay = document.getElementById('gpx-data');
            dataDisplay.innerHTML = '<h4>Datos GPX:</h4>';
            
            data.slice(0, 10).forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'data-item';
                itemDiv.innerHTML = `
                    <strong>Hora:</strong> ${item.time}<br>
                    <strong>Latitud:</strong> ${item.latitude} <strong>Longitud:</strong> ${item.longitude}
                `;
                dataDisplay.appendChild(itemDiv);
            });

            if (data.length > 10) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'data-item';
                moreDiv.innerHTML = `<em>... y ${data.length - 10} registros m√°s</em>`;
                dataDisplay.appendChild(moreDiv);
            }

            dataDisplay.classList.remove('hidden');
        }

        async function generateExpenseReport() {
            const selectedUser = document.getElementById('expense-user-select').value;
            const selectedMonth = document.getElementById('expense-month').value;
            const selectedYear = document.getElementById('expense-year').value;

            if (!selectedUser || !selectedMonth || !selectedYear) {
                showStatus('Por favor selecciona usuario, mes y a√±o.', 'error');
                return;
            }

            let expenseData = allExpenseData;
            
            try {
                const apiData = await apiRequest(`/expenses?user=${selectedUser}&month=${selectedMonth}&year=${selectedYear}`);
                if (apiData && apiData.length > 0) {
                    expenseData = apiData;
                    showStatus('Datos de gastos obtenidos del servidor', 'success');
                }
            } catch (error) {
                expenseData = JSON.parse(localStorage.getItem('expenseData') || '[]');
                showStatus('Usando datos de gastos locales', 'warning');
            }

            const filteredData = expenseData.filter(item => 
                item.user === selectedUser && 
                item.date.startsWith(`${selectedYear}-${selectedMonth.padStart(2, '0')}`)
            );

            if (filteredData.length === 0) {
                showStatus('No se encontraron datos de gastos para el per√≠odo seleccionado.', 'error');
                return;
            }

            displayExpenseData(filteredData);
            downloadExpenseCSV(filteredData, selectedUser, selectedYear, selectedMonth);
            showStatus(`¬°Reporte de gastos generado para ${selectedUser}!`, 'success');
        }

        function displayExpenseData(data) {
            const dataDisplay = document.getElementById('expense-data');
            dataDisplay.innerHTML = '<h4>Datos de Gastos:</h4>';
            
            let totalAmount = 0;
            data.forEach(item => {
                totalAmount += item.amount;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'data-item';
                itemDiv.innerHTML = `
                    <strong>Fecha:</strong> ${item.date} <strong>Hora:</strong> ${item.time}<br>
                    <strong>Descripci√≥n:</strong> ${item.description}<br>
                    <strong>Monto:</strong> ‚Ç¨${item.amount.toFixed(2)}<br>
                    <strong>Ubicaci√≥n:</strong> ${item.latitude}, ${item.longitude}
                `;
                dataDisplay.appendChild(itemDiv);
            });

            const totalDiv = document.createElement('div');
            totalDiv.className = 'data-item';
            totalDiv.style.background = '#e8f5e8';
            totalDiv.innerHTML = `<strong>Total del Mes: ‚Ç¨${totalAmount.toFixed(2)}</strong>`;
            dataDisplay.appendChild(totalDiv);

            dataDisplay.classList.remove('hidden');
        }

        function downloadTimesheetCSV(data, user, year, month) {
            let csv = 'Fecha,Hora,Descripci√≥n,Latitud,Longitud,Kil√≥metros\n';
            data.forEach(item => {
                csv += `${item.date},${item.time},${item.description},${item.latitude},${item.longitude},${item.kilometers || ''}\n`;
            });
            
            const filename = `Timesheet_${user}_${year}_${month.padStart(2, '0')}.csv`;
            downloadFile(csv, filename, 'text/csv');
        }

        function downloadGPXCSV(data, user, date) {
            let csv = 'Fecha,Hora,Latitud,Longitud\n';
            data.forEach(item => {
                csv += `${item.date},${item.time},${item.latitude},${item.longitude}\n`;
            });
            
            const dateObj = new Date(date);
            const filename = `GPX_${dateObj.getFullYear()}_${(dateObj.getMonth() + 1).toString().padStart(2, '0')}_${dateObj.getDate().toString().padStart(2, '0')}_${user}.csv`;
            downloadFile(csv, filename, 'text/csv');
        }

        function downloadExpenseCSV(data, user, year, month) {
            let csv = 'Fecha,Hora,Descripci√≥n,Monto (EUR),Latitud,Longitud\n';
            data.forEach(item => {
                csv += `${item.date},${item.time},"${item.description}",${item.amount},${item.latitude},${item.longitude}\n`;
            });
            
            const filename = `Expenses_${user}_${year}_${month.padStart(2, '0')}.csv`;
            downloadFile(csv, filename, 'text/csv');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType + ';charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Initialize the application when page loads
        window.onload = init;
    </script>
</body>
</html>